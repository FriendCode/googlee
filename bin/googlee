#!/usr/bin/env node
var util = require('util');
var _ = require('underscore');
var optimist = require('optimist');
var googlee = require('../index');

// Constants
var HELP_MSG = [
    'usage: googlee [options]',
    '',
    'Starts a googlee server',
    '',
    'options:',
    '   -t, --timeout TIMEOUT_MILISECONDS       the time to wait for each response',
    '   -p, --port PORT_NUMBER                  the time to wait for each response',
    '   -h, --help                              Display help'
].join('\n');


function Googlee() {
    // Nothing
}

Googlee.prototype.help = function() {
    util.puts(HELP_MSG);
};


Googlee.prototype.main = function(port, timeout) {
    // Run master and worker
    var config = {
        timeout: timeout
    };
    var server = googlee.createServer(config);
    server.listen(port);
};

Googlee.prototype.run = function(argv) {
    var help = argv.h || argv.help;
    var timeout = argv.t || argv.timeout;
    var port = argv.p || argv.port;
    var is_port = !(_.isUndefined(port));
    var is_timeout = !(_.isUndefined(timeout));
    var is_help = !(_.isUndefined(help)) || !(is_port);

    if(is_port) {
        this.main(port, timeout);
    } else if(is_help) {
        return this.help();
    } else {
        return;
    }
};

function main() {
    var argv = optimist.argv;

    var bin = new Googlee();
    bin.run(argv);
}

// Run main
main();